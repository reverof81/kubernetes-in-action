# 3장 파드: 쿠버네티스에서 컨테이너 실행

## 3.1 파드 소개

- 파드
    - 함께 배치된 컨테이너 그룹
    - 하나의 파드에 하나의 컨테이너만 포함되는게 일반적
    - 파드가 여러 컨테이너를 가지고 있을 경우 모든 컨테이너는 항상 하나의 워커 노드에서 실행됨

### 3.1.1 파드가 필요한 이유

- 여러 프로세스를 실행하는 단일 컨테이너보다 다중 컨테이너가 나은 이유
    - 컨테이너는 단일 프로세스를 실행하는 것을 목적으로 설계됨
    - 개발 프로세스가 실패하는 경우 자동으로 재시작하는 매커니즘을 포함해야 함
    - 모든 프로세스는 동일한 표준 출력에 로그를 기록하기 때문에 어떤 프로세스가 남긴 로그인지 파악하는 것이 매우 어렵다.

### 3.1.2 파드 이해하기

- 여러 프로세스를 단일 컨테이너로 묶지 않기 때문에 컨테이너를 묶고 하나의 단위로 관리할 수 있는 또 다른 상위 구조가 필요함
- 컨테이너가 제공하는 모든 기능을 활용하는 동시에 프로세스가 함께 실행되는 것처럼 보이게 할 수 있다.
- 쿠버네티스는 파드 안에 있는 모든 컨테이너가 자체 네임스페이스가 아닌 동일한 리눅스 네임스페이스를 공유하도록 도커를 설정한다.
- 파드의 모든 컨테이너는 동일한 네트워크 네임스페이스와 UTS 네임스페이스 안에서 실행되기 때문에 모든 컨테이너는 같은 호스트 이름과 같은 네트워크 인터페이스를 공유한다.
- 파드의 모든 컨테이너는 동일한 IPC 네임스페이스 아래에서 실행돼 IPC 를 통해 서로 통신할 수 있다.
- 최신 쿠버네티스와 도커에서는 동일한 PID 네임스페이스를 공유할 수 있지만 기본적으로 활성화 돼 있지는 않다.
- 파일 시스템은 다른 컨테이너와 완전히 분리되지만 볼륨을 이용해 파일 디렉토리를 공유하는것이 가능하다.
- 파드 안의 컨테이너가 동일한 네트워크 네임스페이스에서 실행되기 때문에 같은 포트를 사용하지 않도록 주의해야 한다.
- 파드 안의 모든 컨테이너는 동일한 루프백 네트워크 인터페이스를 갖기 때문에 로컬호스트를 통해 서로 통신할 수 있다.
- 쿠버네티스 클러스터의 모든 파드는 하나의 플랫(flat)한 공유 네트워크 주소 공간에 상주하므로 모든 파드는 다른 파드의 IP 주소를 사용해 접근하는 것이 가능하다.

### 3.1.3 파드에서 컨테이너의 적절한 구성

- 애플리케이션을 여러 파드로 구성하고 각 파드에는 밀접하게 관련 있는 구성 요소나 프로세스만 포함해야 한다.
- 스케일링
    - 쿠버네티스는 개별 컨테이너를 수평으로 확장할 수 없다.
    - 파드를 수평으로 확장한다.
    - 컨테이너는 개별적으로 스케일링 하는 것이 필요하다면 별도 파드에 배포해야 한다.
- 파드에서 여러 컨테이너를 사용하는 경우
    - 사이드카 컨테이너: 로그 수집기, 데이터 프로세서, 통신 어댑터 등
- 파드에서 여러 컨테이너를 사용하는 경우 결정
    - 컨테이너를 함께 실행해야 하는가?
    - 여러 컨테이너가 모여 하나의 구성요소를 나타내는가?
    - 컨테이너가 함께 스케일링 돼야 하는가?

## 3.2 YAML 또는 JSON 디스크립터로 파드 생성

- 파드를 포함한 다른 쿠버네티스 리소스는 일반적으로 쿠버네티스 REST API 엔드포인트에 JSON 혹은 YAML 매니페스트를 전송해 생성한다.

### 3.2.1 기존 파드의 YAML 디스크립터 살펴보기

- `kubectl get` 명령과 함께 `-o yaml` 옵션을 사용해 파드의 전체 YAML 정의를 볼 수 있다.
- 파드를 정의하는 주요 부분
    - Metadata: 이름, 네임스페이스, 레이블 및 파드에 관한 기타 정보를 포함한다.
    - Spec: 파드 컨테이너, 볼륨, 기타 데이터 등 파드 자체에 관한 실제 명세를 가진다.
    - Status: 파드 상태, 각 컨테이너 설명과 상태, 파드 내부 IP, 기타 기본 정보 등 현재 실행 중인 파드에 관한 현재 정보를 포함한다.

### 3.2.2 파드를 정의하는 간단한 YAML 정의 작성하기

- 컨테이너 포트 지정
    - 포트 정의 안에 포트를 생략해도 다른 클라이언트에서 포트를 통해 파드에 연결할 수 있다.
    - 포트를 명시적으로 정의한다면 클러스터를 사용하는 모든 사람이 파드에서 노출한 포트를 빠르게 볼 수 있다.
    - 포트를 명시적으로 정의하면 포트에 이름을 지정해 사용할 수 있다.
- 매니페스트를 준비할 때 쿠보네티스 레퍼런스 문서를 참조하거나 `kubectl explain` 명령을 이용해 개별 API 오브젝트에서 지원되는 속성을 확인할 수 있다.
```shell script
$ kubectl explain pods
$ kubectl explain pod.spec
```

### 3.2.3 kubectl create 명령으로 파드 만들기

- YAML 파일을 이횽해 파드를 만들려면, kubectl create 명령을 이용한다.
```shell script
$ kubectl create -f kubia-manual.yaml
```
